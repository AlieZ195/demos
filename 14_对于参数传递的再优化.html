<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
</head>
<body>
	<button>点击获取数据</button>
	<p></p>
	<script type="text/javascript">
		var btn = document.querySelector("button");
		var p = document.querySelector("p");
		btn.addEventListener("click",function(){
			jsonp(function(msg){
				p.innerHTML = msg;
			},"./14.php",{name:"lina",age:23});
		});
		/**
		 * 定义一个函数，用于实现 jsonp 跨域访问
		 * @param  {[type]} callbackFunc [script请求之后的回调函数]
		 * @param  {[type]} url          [请求对应的url]
		 * @param  {[type]} params       [往往是json格式的数据]
		 * @return {[type]}              [description]
		 */
		function jsonp(callbackFunc,url,params){
			// 在创建之前，先去根据id找到是否含有这个属性值的script，如果有，就把这个找到script删了，再动态创建；如果没有，那就动态创建
			var script = document.querySelector("#jp");
			if(script != null){
				document.body.removeChild(script);
			}
			// 1. 动态创建一个script标签
			script = document.createElement("script");
			// 1.1 为这个动态创建好的 script 元素添加一个 id 属性
			script.setAttribute("id","jp");
			var methodName = "jquery_" + (Math.random()+"").substr(2);
			// var methodName = "jquery_" + (new Date().getTime());
			// 有了这个函数名之后，再来进行函数的动态创建
			window[methodName] = callbackFunc;
			// 将 cb 属性设置到 parmas这个 json 格式的对象上
			params["cb"] = methodName;
			var paramStr = joinParams(params);
			// 2. 为这个script元素设置 src 属性
			script.src = url + "?" + paramStr;
			// 3. 将 script 标签添加到页面上
			document.body.appendChild(script);
		}
		// 将json格式的数据转为 参数拼接的字符串格式
		function joinParams(params){
			// 获取对应的当前时间
			var date = new Date();
			// 获取对应的随机数
			var randomNum = Math.random() + "";
			randomNum = randomNum.substr(2);
			// 将这个当前时间戳 以及 随机数 进行拼接，赋值给 params 上的名为 _ 的变量里，这样就能极大程度避免了 url 的重复
			params["_"] = date.getTime() + "_" + randomNum;
			var str = "";
			for(var key in params){
				str += key+"="+params[key] + "&";
			}
			str = str.substr(0,str.length-1);
			return str;
		}
	</script>
</body>
</html>
